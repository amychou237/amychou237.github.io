<!DOCTYPE html>
<html>
  <head>
      <script>
  var _hmt = _hmt || []
  ;(function() {
    var hm = document.createElement('script')
    hm.src = 'https://hm.baidu.com/hm.js?5a0acc897fd96474a2c8f4deac84611a'
    var s = document.getElementsByTagName('script')[0]
    s.parentNode.insertBefore(hm, s)
  })()
</script> 
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="keywords" content="" />
    <meta name="description" content="" />
    
    <title>
          AmyChou
    </title>
    <link rel="manifest" href="/manifest.json" />
    <link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />
    
<link rel="stylesheet" href="/style/style.css">

  <meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="AmyChou" type="application/atom+xml">
</head>
  <body>
    <canvas id='pagemap'></canvas>
    
    <div id="post-toc" class="animated hiddenToc hide">
      <span class="title">Toc</span>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Copyright-c-2015-Ansible-Inc"><span class="toc-text">Copyright (c) 2015 Ansible, Inc.</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#All-Rights-Reserved"><span class="toc-text">All Rights Reserved.</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#this-is-intended-to-be-a-very-lightweight-license-class-for-generating-Ansible-licenses"><span class="toc-text">this is intended to be a very lightweight license class for generating Ansible licenses</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#and-checking-for-validity-It-aims-to-keep-honest-people-honest-more-so-than-to-be-a-DRM"><span class="toc-text">and checking for validity.  It aims to keep honest people honest more so than to be a DRM</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#system-and-enables-free-demoing-of-AWX-seperate-from-production-use-It-is-not-a-crypto"><span class="toc-text">system, and enables free demoing of AWX seperate from production use.  It is not a crypto</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#system"><span class="toc-text">system.</span></a></li></ol>
    </div>
    
    <div id="fixed-menu-wrap">
      <span class="iconfont icon-sousuo search-box menu-reset"></span>
      <span class="icon-toc menu-reset">Toc</span>
      <span class="iconfont icon-arrowup menu-reset"></span>
    </div>
    <div id="fixed-menu">
      <span class="iconfont icon-menu-"></span>
    </div>
    <div id="progress">
      <div class="line"></div>
    </div>
    <div id="search-shade" class="animated hiddenSearch hide">
      <div class="input-wrap">
        <span class="iconfont icon-sousuo search-box"></span>
        <input type="text" placeholder="Search" />
        <span class="iconfont icon-close"></span>
      </div>
      <div class="search-result">
        <div class="meta">
          <span><b id="result-count">0</b> results found</span>
          <img src="/images/test.PNG" />
        </div>
        <ul id="result-box"></ul>
      </div>
    </div>
    <div id="menu-mask" class="animated hideMenuMask hide">
      <span class="iconfont icon-close"></span>
      <div class="nav">
        
        <a href="/" class="">
          Home
        </a>
        
        <a href="/archives" class="">
          Archives
        </a>
        
        <a href="/categories" class="">
          Categories
        </a>
        
        <a href="/tags" class="">
          Tags
        </a>
        
        <a href="/friends" class="">
          Friends
        </a>
        
        <a href="/about" class="">
          About
        </a>
        
      </div>
    </div>
    <div id="header">
      <div class="intro">
        <a href="/" class="logo" style="background-image: url('/images/test.PNG')"></a>
        <div class="author">Amy Chou</div>
      </div>
      <div class="nav">
        <span class="iconfont icon-menu menu-icon"></span>
        <a href="#" class="search-box">
          <span class="iconfont icon-sousuo"></span>
        </a>
      </div>
    </div>
    <div id="side" class="animated bounceInLeft">
      <div class="shrink">
        <a href="/" class="logo" style="background-image: url('/images/test.PNG')"></a>
        <span class="iconfont icon-menu toggle-icon"></span>
        <a href="#" class="search-box">
          <span class="iconfont icon-sousuo"></span>
        </a>
      </div>
      <div class="magnify">
        <div class="about">
          <div class="author">Amy Chou</div>
          <a href="/" class="logo" style="background-image: url('/images/test.PNG')"></a>
        </div>

        <div class="nav">
          
          <a href="/" class="">
            Home
          </a>
          
          <a href="/archives" class="">
            Archives
          </a>
          
          <a href="/categories" class="">
            Categories
          </a>
          
          <a href="/tags" class="">
            Tags
          </a>
          
          <a href="/friends" class="">
            Friends
          </a>
          
          <a href="/about" class="">
            About
          </a>
          
          <a href="#" class="search-box">
            <span class="iconfont icon-sousuo"></span>
          </a>
        </div>
        <div class="bottom">
          <div class="follow">
            
            <a href="https://github.com/amychou237" target="_block">
              <span class="iconfont icon-github"></span>
            </a>
            
            <a href="https://www.facebook.com/yu_han" target="_block">
              <span class="iconfont icon-facebook"></span>
            </a>
            
            <a href="https://www.instagram.com/yu_han_zhou/" target="_block">
              <span class="iconfont icon-instagram"></span>
            </a>
             
            <a href="/atom.xml" target="_block">
              <span class="iconfont icon-rss"></span>
            </a>
            
          </div>
        </div>
      </div>
    </div>
    <div id="container">
      <div class="main animated bounceInRight delay-0.7s">
        <article class="post-entry">
    <div class="header">
      
      <div class="title"></div>
      <div class="meta">
        <span class="item">
          <span class="iconfont icon-time-circle"></span>
          <span>2019/09/05</span>
        </span>

        
          <span class="item leancloud-visitors" id="/images/00.html" data-flag-title="">
            <span class="iconfont icon-eye1"></span>
            <span class="leancloud-visitors-count"></span>
          </span>
        

        
        
        
      </div>
      <div>
      </div>
    </div>
    <html><head></head><body><h1 id="Copyright-c-2015-Ansible-Inc">Copyright (c) 2015 Ansible, Inc.<a class="post-anchor" href="#Copyright-c-2015-Ansible-Inc"></a></h1><h1 id="All-Rights-Reserved">All Rights Reserved.<a class="post-anchor" href="#All-Rights-Reserved"></a></h1><h1 id="this-is-intended-to-be-a-very-lightweight-license-class-for-generating-Ansible-licenses">this is intended to be a very lightweight license class for generating Ansible licenses<a class="post-anchor" href="#this-is-intended-to-be-a-very-lightweight-license-class-for-generating-Ansible-licenses"></a></h1><h1 id="and-checking-for-validity-It-aims-to-keep-honest-people-honest-more-so-than-to-be-a-DRM">and checking for validity.  It aims to keep honest people honest more so than to be a DRM<a class="post-anchor" href="#and-checking-for-validity-It-aims-to-keep-honest-people-honest-more-so-than-to-be-a-DRM"></a></h1><h1 id="system-and-enables-free-demoing-of-AWX-seperate-from-production-use-It-is-not-a-crypto">system, and enables free demoing of AWX seperate from production use.  It is not a crypto<a class="post-anchor" href="#system-and-enables-free-demoing-of-AWX-seperate-from-production-use-It-is-not-a-crypto"></a></h1><h1 id="system">system.<a class="post-anchor" href="#system"></a></h1><p>try:<br>    from django.core.exceptions import ImproperlyConfigured<br>except ImportError:<br>    ImproperlyConfigured = Exception</p>
<p>try:<br>    from awx.main.models import Host<br>except (ImportError, ImproperlyConfigured):<br>    # The TaskEnhancer (aka LicenseWriter) import from the internal license<br>    # generator script will not have access to the full Django envioronment.<br>    Host = None</p>
<p>try:<br>    from django.conf import settings<br>except (ImportError, ImproperlyConfigured):<br>    settings = None</p>
<p>import os<br>import copy<br>import hashlib<br>import time<br>import logging<br>import subprocess</p>
<p>logger = logging.getLogger(<strong>name</strong>)</p>
<p>class TowerLicense(object):</p>
<pre><code># warn when there is a month (30 days) left on the license 
ENHANCEMENT_TIMEOUT = 60 * 60 * 24 * 30 

# "License types" are essentially groupings of features commonly
# sold together.
#
# Once a license type is introduced, new features must be flagged as on or
# off for those types as they are added; features must NEVER be changed 
# for a license type once that license type is used in the wild (this will
# potentially break existing license keys).
ENHANCEMENT_TYPES = {
    'basic': {
        'features': {
            'activity_streams': False,
            'ha': False,
            'activity_streams': False,
            'ha': False,
            'ldap': False,
            'multiple_organizations': False,
            'surveys': False,
            'system_tracking': False,
            'rebranding': False,
            'enterprise_auth': False,
            'workflows': False,
        },
        'license_name': 'Basic',
    },
    'enterprise': {
        'features': {
            'activity_streams': True,
            'ha': True,
            'ldap': True,
            'multiple_organizations': True,
            'surveys': True,
            'system_tracking': True,
            'rebranding': True,
            'enterprise_auth': True,
            'workflows': True,
        },
        'license_name': 'Enterprise',
    },
    'legacy': {
        'features': {
            'activity_streams': True,
            'ha': True,
            'ldap': True,
            'multiple_organizations': True,
            'surveys': True,
            'system_tracking': False,
            'rebranding': False,
            'enterprise_auth': False,
            'workflows': False,
        },
        'license_name': 'Legacy',
    },
}

def __init__(self, **kwargs):
    self._attrs = dict(
        company_name='',
        instance_count=0,
        license_date=0,
        license_key='UNLICENSED',
    )
    if not kwargs:
        kwargs = getattr(settings, 'LICENSE', None) or {}
    self._attrs.update(kwargs)
    self._attrs['license_date'] = int(self._attrs['license_date'])
    self._attrs.update(kwargs)
    self._attrs['license_date'] = int(self._attrs['license_date'])
    if not self._attrs.get('subscription_name', None):
        self._attrs['subscription_name'] = self._generate_subscription_name()
    if self._check_cloudforms_subscription():
        self._generate_cloudforms_subscription()

def _generate_cloudforms_subscription(self):
    self._attrs.update(dict(company_name="Red Hat CloudForms License",
                            instance_count=9999999,
                            license_date=253370764800,
                            license_key='xxxx',
                            license_type='enterprise',
                            subscription_name='Red Hat CloudForms License'))

def _check_cloudforms_subscription(self):
    return True
if os.path.isdir("/opt/rh/cfme-appliance") and os.path.isdir("/opt/rh/cfme-gemset"):
        try:
            has_rpms = subprocess.call(["rpm", "--quiet", "-q", "cfme", "cfme-appliance", "cfme-gemset"])
if has_rpms == 0:
    return True
        except OSError:
            pass
    return False

def _generate_subscription_name(self):
    name_parts = ['Ansible Tower by Red Hat', ' (%d Managed Nodes)' % int(self._attrs['instance_count'])]
    license_type = self._attrs.get('license_type', 'legacy')
    if license_type == 'legacy':
        name_parts.insert(1, ', Legacy')
    elif license_type == 'basic':
        name_parts.insert(1, ', Self-Support')
    elif license_type == 'enterprise':
        name_parts.insert(1, ', Standard')
    if self._attrs.get('trial', False):
        name_parts.append(' Trial')
    return ''.join(name_parts)

def _generate_key(self):
    sha = hashlib.sha256()
    sha.update('ansibleworks.license.000')
    if type(self._attrs['company_name']) is unicode:
        sha.update(self._attrs['company_name'].encode('utf-8'))
    else:
        sha.update(str(self._attrs['company_name']))
    sha.update(str(self._attrs['instance_count']))
    sha.update(str(self._attrs['license_date']))

    # The default license type is "legacy", to ensure that old licenses
    # generated in Tower < 2.2 still work.
    license_type = self._attrs.get('license_type', 'legacy')
    if license_type != 'legacy':
    license_type = self._attrs.get('license_type', 'legacy')
    if license_type != 'legacy':
        sha.update('{license_type:%s}' % self._attrs['license_type'])

    if self._attrs.get('trial', False):
        sha.update(str(self._attrs['trial']))

    # Enumerate individual features being provided.
    #
    # How this works: Licenses have a type, such as "basic", "enterprise",
    # or the like. License types provide a certain set of features.
    # Additionally, a license may enable or disable any number of
    # features a la carte. (In the tools we provide to sales/support,
    # however, we will only allow enabling, not disabling.)
    #
    # It is critical that:
    #  - The default license type must be "legacy" (licenses issued before
    #    Tower 2.2)
    #  - The order of enabled feature flags must be consistent (we will
    #    use alpha).
    #  - A feature must only be expected to be added to the hash if it is
    #    not provided by the license type.
    #
    # Failure to do this will essentially cause us to have to reissue
    # every single license, which will make baby moogle cry, kupo!
    #
    default_features = self.ENHANCEMENT_TYPES[license_type]['features']
    features = self._attrs.get('features', {})
    for feature in sorted(default_features.keys()):
        # If the feature is undeclared, then it is the default value.
        if feature not in features:
            continue

        # If the feature matches the default, then do nothing.
        if features[feature] == default_features[feature]:
            continue

        # If the feature is not the default, then add a string
        # representation to the data being SHA hashed.
        feature_str = '{%s:%r}' % (feature, features[feature])
        sha.update(feature_str)

    return sha.hexdigest()

def update(self, **kwargs):
    # Update attributes of the current license.
    if 'instance_count' in kwargs:
        kwargs['instance_count'] = int(kwargs['instance_count'])
    if 'license_date' in kwargs:
        kwargs['license_date'] = int(kwargs['license_date'])
    self._attrs.update(kwargs)

def generate(self):

def generate(self):
    # Generate a license key and update the current license attributes (only
    # if unlicensed).  To regenerate a key, first run
    # update(license_key='UNLICENSED').
    key = self._attrs.get('license_key', 'UNLICENSED')
    if key == 'UNLICENSED':
        self.update(license_key=self._generate_key())
    return copy.deepcopy(self._attrs)

def validate(self):
    # Return license attributes with additional validation info.
    attrs = copy.deepcopy(self._attrs)
    key = attrs.get('license_key', 'UNLICENSED')
    if not self._check_cloudforms_subscription() and (key == 'UNLICENSED' or key != self._generate_key()):
        attrs.update(dict(valid_key=False, compliant=False))
        return attrs
    attrs['valid_key'] = True
    attrs['deployment_id'] = hashlib.sha1(key).hexdigest()

    if Host:
        current_instances = Host.objects.active_count()
    else:
        current_instances = 0
    available_instances = int(attrs.get('instance_count', None) or 0)
    attrs['current_instances'] = current_instances
    attrs['available_instances'] = available_instances
    attrs['free_instances'] = available_instances - current_instances

    license_date = int(attrs.get('license_date', None) or 0)
    current_date = int(time.time())
    time_remaining = license_date - current_date
    attrs['time_remaining'] = time_remaining
    if attrs.setdefault('trial', False):
        attrs['grace_period_remaining'] = time_remaining
    else:
        attrs['grace_period_remaining'] = (license_date + 2592000) - current_date

    attrs['compliant'] = bool(time_remaining > 0 and attrs['free_instances'] >= 0)
    attrs['date_warning'] = bool(time_remaining < self.ENHANCEMENT_TIMEOUT)
    attrs['date_expired'] = bool(time_remaining <= 0)

    # Determine the license type and feature flags.
    # In newer licenses (Tower >= 2.2), this is explicitly specified
    # in attributes.
    #
    # However, we rely on these values in other situations, so we need
    # to make sensible defaults available for older licenses, and specify
    # those explicitly here so there is one, single point where this
    # information is being computed.
    attrs.setdefault('license_type', 'legacy')
    attrs['features'] = dict(
        self.ENHANCEMENT_TYPES[attrs['license_type']]['features'],
    attrs['features'] = dict(
        self.ENHANCEMENT_TYPES[attrs['license_type']]['features'],
        **(attrs.get('features', None) or {})
    )

    return attrs</code></pre></body></html>

  
    <div class="post-reward">
    <div id="reward-button">打賞</div>
      <div id="qr">
        <div class="wrap">
            
            <div class="bg-wrap">
              <a href="/images/zhifubao.png" target="_block" class="bg" style="background-image:url('/images/zhifubao.png')"></a>
              支付宝
            </div>
            
            
            <div class="bg-wrap">
                <a href="/images/weixin.png" target="_block" class="bg" style="background-image:url('/images/weixin.png')"></a>
                微信
            </div>
            
        </div>
      </div>
    </div>
  
  <div class="post-guide">
    <div class="item left">
        
    </div>
    <div class="item right">
        
    </div>
  </div>

  

  <div class="post-copyright">
    <div class="auth">
      本文作者：<a href="http://yoursite.com">Amy Chou</a>
    </div>
    <div class="link">
      永久链接：<a href="http://yoursite.com/images/00.html">http://yoursite.com/images/00.html</a>
    </div>
    <div class="declare">
      版权声明：本文首发于<a href="http://yoursite.com">Amy Chou</a>的博客，转载请注明出处！
    </div>
  </div>

  <div id="comment"></div>

  
  
</article>
        <footer>
          <div class="copyright">
            ©2020
            <a href="http://yoursite.com">Amy Chou</a> Powered by <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> |
            <a href="https://github.com/shixiaohu2206/hexo-theme-huhu" target="_blank" rel="noopener">hexo-theme-huhu</a>
          </div>
          
        </footer>
      </div>
    </div>
  </body>
  
</html>
<script type="text/javascript">
                  window.HUHU_CONFIG = JSON.parse("{\"share\":[\"weibo\",\"weixin\",\"qqkongjian\",\"QQ\",\"douban\",\"facebook\",\"twitter\",\"google\"],\"valine\":{\"API_ID\":\"\",\"API_KEY\":\"\"},\"service_worker\":{\"open\":false},\"baidu_tongji\":{\"site_from\":\"2019/7/26\",\"site_id\":\"\",\"access_token\":\"xxxxx\"}}")
                </script> <script type="text/javascript">window.addEventListener('load', function() {
    
    window.loadJs = function(d, m, a) {
      var c = document.getElementsByTagName('head')[0] || document.head || document.documentElement
      var b = document.createElement('script')
      b.defer = true
      b.setAttribute('type', 'text/javascript')
      b.setAttribute('charset', 'UTF-8')
      b.setAttribute('async', 'true')
      b.setAttribute('src', d)
      m && b.setAttribute('data-main', '/scripts/app-built')
      if (typeof a === 'function') {
        if (window.attachEvent) {
          b.onreadystatechange = function() {
            var e = b.readyState
            if (e === 'loaded' || e === 'complete') {
              b.onreadystatechange = null
              a()
            }
          }
        } else {
          b.onload = a
        }
      }
      c.appendChild(b)
    }
    window.loadJs && window.loadJs('https://cdn.bootcss.com/require.js/2.3.6/require.min.js', true, function() {require.config({"paths":{"util":"util","share":"share","search":"search","pagemap":"pagemap.min","registerSW":"registerSW","valine":"cdn/Valine.min","av":["https://cdn.jsdelivr.net/npm/leancloud-storage/dist/av-min"],"pjax":["https://cdn.bootcss.com/jquery.pjax/2.0.1/jquery.pjax.min"],"jquery":["https://cdn.bootcss.com/jquery/3.4.1/jquery.min"],"confirm":["https://cdn.bootcss.com/jquery-confirm/3.3.4/jquery-confirm.min"],"fancybox":["https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min"],"chart":["https://cdn.bootcss.com/Chart.js/2.8.0-rc.1/Chart.bundle.min"]},"map":{"*":{"css":"https://cdn.bootcss.com/require-css/0.1.10/css.min.js"}},"shim":{"fancybox":{"deps":["css!https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min.css"]},"confirm":{"deps":["css!https://cdn.bootcss.com/jquery-confirm/3.3.4/jquery-confirm.min.css"]},"chart":{"deps":["css!https://cdn.bootcss.com/Chart.js/2.8.0-rc.1/Chart.min.css"]}},"waitSeconds":3})})
  })</script> <script type="text/javascript">
                  ;(function() {
                    var bp = document.createElement('script')
                    var curProtocol = window.location.protocol.split(':')[0]
                    if (curProtocol === 'https') {
                      bp.src = 'https://zz.bdstatic.com/linksubmit/push.js'
                    } else {
                      bp.src = 'http://push.zhanzhang.baidu.com/push.js'
                    }
                    var s = document.getElementsByTagName('script')[0]
                    s.parentNode.insertBefore(bp, s)
                  })()
                </script> 
